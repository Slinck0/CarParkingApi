# .github/workflows/dotnet.yml
name: CI – V2 .NET 9 API

# -------------------------------------------------
# Trigger only when V2 code changes
# -------------------------------------------------
on:
  push:
    branches: [ main, CI/CD, dev, 'release/*' ]
    paths:
      - 'V2/**'
      - 'Parking-api.sln'
      - '.github/workflows/dotnet.yml'
  pull_request:
    branches: [ main, CI/CD, dev, 'release/*' ]
    paths:
      - 'V2/**'
      - 'Parking-api.sln'
      - '.github/workflows/dotnet.yml'

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write   # for CodeQL

env:
  SOLUTION: Parking-api.sln
  PROJECT:  V2/V2.csproj
  PUBLISH:  V2/bin/Release/net9.0/linux-x64/publish
  ZIP:      car-parking-api-v2-${{ github.sha }}.zip

jobs:
  # -------------------------------------------------
  # 1. Restore + cache
  # -------------------------------------------------
  restore:
    name: Restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json', env.SOLUTION) }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - run: dotnet workload restore ${{ env.SOLUTION }} --verbosity minimal
      - run: dotnet restore ${{ env.SOLUTION }} --locked-mode

  # -------------------------------------------------
  # 2. Lint / format
  # -------------------------------------------------
  lint:
    name: Lint
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet format ${{ env.SOLUTION }} --verify-no-changes --severity info \
          || (echo "Fix formatting with 'dotnet format'" && exit 1)

  # -------------------------------------------------
  # 3. Unit tests + coverage
  # -------------------------------------------------
  unit-tests:
    name: Unit Tests
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet test ${{ env.SOLUTION }} \
          --no-restore --no-build -c Release \
          --collect:"XPlat Code Coverage" \
          --logger trx \
          --results-directory test-results \
          --filter "FullyQualifiedName!~Integration" \
          /p:CoverletOutputFormat=cobertura \
          /p:CoverletOutput=./coverage/

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/**

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/coverage.cobertura.xml

      # ---- Enforce 80 % coverage (GitHub Summary) ----
      - name: Check coverage
        run: |
          COVERAGE=$(dotnet reportgenerator \
            -reports:coverage/coverage.cobertura.xml \
            -targetdir:coveragereport -reporttypes:TextSummary \
            | grep "Line coverage" | awk '{print $3}' | tr -d '%')
          echo "Line coverage: $COVERAGE%"
          echo "## Coverage: $COVERAGE %" >> $GITHUB_STEP_SUMMARY
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "Coverage < 80 % → failing"
            exit 1
          fi
        env:
          DOTNET_ROOT: ${{ runner.tool_cache }}/dotnet

  # -------------------------------------------------
  # 4. Integration tests (run on main or PR with tag)
  # -------------------------------------------------
  integration-tests:
    name: Integration Tests
    needs: restore
    runs-on: ubuntu-latest
    if: >-
      github.ref == 'refs/heads/main' ||
      contains(github.event.pull_request.title, '[run-integration]')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet test ${{ env.SOLUTION }} \
          --no-restore --no-build -c Release \
          --filter "FullyQualifiedName~Integration" \
          --logger trx

  # -------------------------------------------------
  # 5. Build (warnings = errors)
  # -------------------------------------------------
  build:
    name: Build
    needs: [lint, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet build ${{ env.SOLUTION }} \
          --no-restore -c Release \
          /p:TreatWarningsAsErrors=true \
          /p:RuntimeIdentifier=linux-x64

  # -------------------------------------------------
  # 6. Publish + zip
  # -------------------------------------------------
  publish:
    name: Publish
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet publish ${{ env.PROJECT }} \
          -c Release --no-build --self-contained false \
          --runtime linux-x64 --output ${{ env.PUBLISH }}

      - name: Zip artifact
        run: |
          cd V2/bin/Release/net9.0/linux-x64
          zip -r "${{ github.workspace }}/${{ env.ZIP }}" .
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP }}
          path: ${{ env.ZIP }}
          retention-days: 7

  # -------------------------------------------------
  # 7. Security scan (dotnet + CodeQL)
  # -------------------------------------------------
  security:
    name: Security
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet list ${{ env.PROJECT }} package --vulnerable --include-transitive > vuln.txt || true
      - name: Show vulnerable packages
        run: |
          echo "## Vulnerable Packages" >> $GITHUB_STEP_SUMMARY
          if grep -q "has the following vulnerable packages" vuln.txt; then
            echo "Critical vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            cat vuln.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "No critical vulnerabilities." >> $GITHUB_STEP_SUMMARY
          fi

      - uses: github/codeql-action/init@v3
        with:
          languages: csharp
      - uses: github/codeql-action/analyze@v3

  # -------------------------------------------------
  # 8. Outdated packages (warning only)
  # -------------------------------------------------
  outdated:
    name: Outdated Packages
    needs: restore
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet tool install --global dotnet-outdated-tool
      - run: |
          echo "## Outdated Packages" >> $GITHUB_STEP_SUMMARY
          dotnet outdated ${{ env.SOLUTION }} -f text >> $GITHUB_STEP_SUMMARY || echo "None"

# -------------------------------------------------
# End of file
# -------------------------------------------------
