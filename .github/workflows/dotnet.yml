# .github/workflows/ci-cd.yml   (or rename to dotnet.yml if you prefer)
name: CI/CD â€“ V2 .NET 9 API

on:
  push:
    branches: [ main, CI/CD, dev, 'release/*' ]
    paths:
      - 'V2/**'
      - 'Parking-api.sln'
      - '.github/workflows/ci-cd.yml'
  pull_request:
    branches: [ main, CI/CD, dev, 'release/*' ]
    paths:
      - 'V2/**'
      - 'Parking-api.sln'
      - '.github/workflows/ci-cd.yml'

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  SOLUTION_FILE: Parking-api.sln
  PROJECT_PATH: V2/V2.csproj
  PUBLISH_DIR: V2/bin/Release/net9.0/linux-x64/publish
  ARTIFACT_NAME: car-parking-api-v2-${{ github.sha }}.zip

jobs:
  # --------------------------------------------------------------
  # 1. Restore & cache
  # --------------------------------------------------------------
  restore:
    name: Restore & Cache
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache.outputs.cache-key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache-dependency-path: ${{ env.SOLUTION_FILE }}

      - name: Cache NuGet
        id: cache
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json', env.SOLUTION_FILE) }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Workload restore
        run: dotnet workload restore ${{ env.SOLUTION_FILE }} --verbosity minimal

      - name: Restore solution
        run: dotnet restore ${{ env.SOLUTION_FILE }} --locked-mode --verbosity minimal

  # --------------------------------------------------------------
  # 2. Lint / format
  # --------------------------------------------------------------
  lint:
    name: Lint & Format
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet restore ${{ env.SOLUTION_FILE }} --no-cache
      - name: Verify formatting
        run: |
          dotnet format ${{ env.SOLUTION_FILE }} \
            --verify-no-changes --severity info --include-generated \
          || (echo "Fix formatting with 'dotnet format' locally" && exit 1)

  # --------------------------------------------------------------
  # 3. SonarCloud analysis
  # --------------------------------------------------------------
  analyze:
    name: SonarCloud
    needs: restore
    runs-on: ubuntu-latest
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet restore ${{ env.SOLUTION_FILE }}
      - run: dotnet tool install --global dotnet-sonarscanner
      - name: Sonar begin
        env:
          SONAR_PROJECT_KEY: ${{ github.repository }}-v2
        run: |
          dotnet sonarscanner begin \
            /k:"${{ env.SONAR_PROJECT_KEY }}" \
            /o:"${{ github.repository_owner }}" \
            /d:sonar.login="${{ env.SONAR_TOKEN }}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="**/*.coverage.xml" \
            /d:sonar.exclusions="**/V1/**,**/tests/**" \
            /d:sonar.coverage.exclusions="**/*Tests.cs"
      - run: dotnet build ${{ env.SOLUTION_FILE }} --no-restore -c Release
      - name: Tests for Sonar
        run: |
          dotnet test ${{ env.SOLUTION_FILE }} \
            --no-build --collect:"XPlat Code Coverage" \
            --settings .runsettings --logger trx
      - run: dotnet sonarscanner end /d:sonar.login="${{ env.SONAR_TOKEN }}"

  # --------------------------------------------------------------
  # 4. Unit tests + coverage
  # --------------------------------------------------------------
  unit-tests:
    name: Unit Tests
    needs: restore
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['9.0.x']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: ${{ matrix.dotnet-version }} }
      - run: dotnet restore ${{ env.SOLUTION_FILE }}
      - name: Run tests
        run: |
          dotnet test ${{ env.SOLUTION_FILE }} \
            --no-restore --no-build -c Release \
            --collect:"XPlat Code Coverage" --logger trx \
            --results-directory ./test-results \
            --filter "FullyQualifiedName!~Integration" \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=./coverage/
      - uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: ./test-results/**
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./coverage/coverage.cobertura.xml
      - uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage.cobertura.xml
          flags: unittests
          minimum_coverage: 80

  # --------------------------------------------------------------
  # 5. Integration tests (optional)
  # --------------------------------------------------------------
  integration-tests:
    name: Integration Tests
    needs: restore
    runs-on: ubuntu-latest
    if: >-
      contains(github.event.pull_request.title, '[run-integration]') ||
      github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet restore ${{ env.SOLUTION_FILE }}
      - run: |
          dotnet test ${{ env.SOLUTION_FILE }} \
            --no-restore --no-build -c Release \
            --filter "FullyQualifiedName~Integration" \
            --logger trx

  # --------------------------------------------------------------
  # 6. Build
  # --------------------------------------------------------------
  build:
    name: Build
    needs: [lint, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet restore ${{ env.SOLUTION_FILE }}
      - run: |
          dotnet build ${{ env.SOLUTION_FILE }} \
            --no-restore -c Release \
            /p:TreatWarningsAsErrors=true \
            /p:RuntimeIdentifier=linux-x64

  # --------------------------------------------------------------
  # 7. Publish artifact
  # --------------------------------------------------------------
  publish-artifacts:
    name: Publish Artifact
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - name: Publish
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            -c Release --no-build --self-contained false \
            --runtime linux-x64 --output ${{ env.PUBLISH_DIR }}
      - name: Zip
        run: |
          cd V2/bin/Release/net9.0/linux-x64
          zip -r "${{ github.workspace }}/${{ env.ARTIFACT_NAME }}" .
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}
          retention-days: 7

  # --------------------------------------------------------------
  # 8. Security scan
  # --------------------------------------------------------------
  security-scan:
    name: Security Scan
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet restore ${{ env.SOLUTION_FILE }}
      - name: Vulnerable packages
        id: vuln
        run: |
          echo "## Vulnerable Packages" >> $GITHUB_STEP_SUMMARY
          dotnet list ${{ env.PROJECT_PATH }} package --vulnerable --include-transitive > vuln.txt || true
          if grep -q "has the following vulnerable packages" vuln.txt; then
            echo "Critical vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            grep -A 100 "has the following vulnerable packages" vuln.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "No critical vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi
      - uses: github/codeql-action/init@v3
        with:
          languages: csharp
          config-file: .github/codeql-config.yml
      - uses: github/codeql-action/analyze@v3

  # --------------------------------------------------------------
  # 9. PR preview deploy
  # --------------------------------------------------------------
  deploy-preview:
    name: Deploy Preview (PR)
    if: github.event_name == 'pull_request'
    needs: [publish-artifacts, security-scan]
    runs-on: ubuntu-latest
    environment: preview
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./artifact
      - name: Deploy (placeholder)
        run: |
          echo "Deploying PR #${{ github.event.pull_request.number }} ..."
          # az webapp deploy ... (replace with your real command)
      - uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Preview: https://preview-${{ github.event.pull_request.number }}.example.com`
            })

  # --------------------------------------------------------------
  # 10. Outdated packages (warning only)
  # --------------------------------------------------------------
  outdated:
    name: Outdated Packages
    needs: restore
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - run: dotnet tool install --global dotnet-outdated-tool
      - name: Check
        run: |
          echo "## Outdated Packages" >> $GITHUB_STEP_SUMMARY
          dotnet outdated ${{ env.SOLUTION_FILE }} -f text >> $GITHUB_STEP_SUMMARY || echo "None"
