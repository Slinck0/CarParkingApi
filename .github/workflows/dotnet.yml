# .github/workflows/dotnet.yml
name: CI – V2 .NET 9 API

on:
  push:
    branches: [ main, CI/CD, dev, 'release/*' ]
    paths:
      - 'V2/**'
      - 'Parking-api.sln'
      - '.github/workflows/dotnet.yml'
  pull_request:
    branches: [ main, CI/CD, dev, 'release/*' ]
    paths:
      - 'V2/**'
      - 'Parking-api.sln'
      - '.github/workflows/dotnet.yml'

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

env:
  SOLUTION: Parking-api.sln
  PROJECT: V2/V2.csproj
  PUBLISH: V2/bin/Release/net9.0/linux-x64/publish
  ZIP: car-parking-api-v2-${{ github.sha }}.zip

jobs:
  # ==============================================================
  # 1. Restore + Cache
  # ==============================================================
  restore:
    name: Restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json', env.SOLUTION) }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - run: dotnet workload restore ${{ env.SOLUTION }} --verbosity minimal
      - run: dotnet restore ${{ env.SOLUTION }} --locked-mode

  # ==============================================================
  # 2. Lint & Format (REAL check)
  # ==============================================================
  lint:
    name: Lint & Format
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Verify formatting
        run: |
          echo "Checking whitespace..."
          dotnet format ${{ env.SOLUTION }} whitespace \
            --verify-no-changes --verbosity quiet || exit 1

          echo "Checking code style..."
          dotnet format ${{ env.SOLUTION }} style \
            --verify-no-changes --verbosity quiet || exit 1

          echo "Checking analyzers..."
          dotnet format ${{ env.SOLUTION }} analyzers \
            --verify-no-changes --verbosity quiet || exit 1

          echo "Formatting check passed!"
        shell: bash

  # ==============================================================
  # 3. Unit Tests + Coverage (80%+)
  # ==============================================================
  unit-tests:
    name: Unit Tests
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Run unit tests
        run: |
          dotnet test ${{ env.SOLUTION }} \
            --no-restore --no-build -c Release \
            --collect:"XPlat Code Coverage" \
            --logger trx \
            --results-directory test-results \
            --filter "FullyQualifiedName!~Integration" \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=./coverage/

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/**

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/coverage.cobertura.xml

      - name: Enforce 80% coverage
        run: |
          echo "## Code Coverage" >> $GITHUB_STEP_SUMMARY

          # Find the *first* cobertura file that exists
          FILE=$(find . -path "*/coverage/*.cobertura.xml" | head -n1)
          if [ -z "$FILE" ]; then
            echo "Coverage file missing!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Extract **all** line-rate values and compute the average
          RATES=$(grep -oP '<line-rate>\K[0-9.]+' "$FILE")
          SUM=0; COUNT=0
          for r in $RATES; do
            SUM=$(echo "$SUM + $r" | bc -l)
            COUNT=$((COUNT + 1))
          done

          if [ "$COUNT" -eq 0 ]; then
            echo "No coverage data found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          AVG=$(echo "scale=4; $SUM / $COUNT" | bc -l)
          PERCENT=$(echo "$AVG * 100" | bc -l | awk '{printf "%.2f", $1}')

          echo "Line coverage: $PERCENT% (averaged over $COUNT report(s))" >> $GITHUB_STEP_SUMMARY

          if (( $(echo "$PERCENT < 80" | bc -l) )); then
            echo "Coverage < 80% → failing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ==============================================================
  # 4. Integration Tests (main or [run-integration])
  # ==============================================================
  integration-tests:
    name: Integration Tests
    needs: restore
    runs-on: ubuntu-latest
    if: >-
      github.ref == 'refs/heads/main' ||
      contains(github.event.pull_request.title, '[run-integration]')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - run: dotnet test ${{ env.SOLUTION }} \
          --no-restore --no-build -c Release \
          --filter "FullyQualifiedName~Integration" \
          --logger trx

  # ==============================================================
  # 5. Build (warnings = errors)
  # ==============================================================
  build:
    name: Build
    needs: [lint, unit-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - run: dotnet build ${{ env.SOLUTION }} \
          --no-restore -c Release \
          /p:TreatWarningsAsErrors=true \
          /p:RuntimeIdentifier=linux-x64

  # ==============================================================
  # 6. Publish + Zip Artifact
  # ==============================================================
  publish:
    name: Publish Artifact
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release --no-build --self-contained false \
            --runtime linux-x64 --output ${{ env.PUBLISH }}

      - name: Create zip
        run: |
          cd V2/bin/Release/net9.0/linux-x64
          zip -r "${{ github.workspace }}/${{ env.ZIP }}" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP }}
          path: ${{ env.ZIP }}
          retention-days: 7

  # ==============================================================
  # 7. Security Scan (Vulns + CodeQL)
  # ==============================================================
  security:
    name: Security Scan
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Check vulnerable packages
        run: |
          echo "## Vulnerable Packages" >> $GITHUB_STEP_SUMMARY
          dotnet list ${{ env.PROJECT }} package --vulnerable --include-transitive > vuln.txt || true
          if grep -q "has the following vulnerable packages" vuln.txt; then
            echo "CRITICAL VULNERABILITIES FOUND!" >> $GITHUB_STEP_SUMMARY
            cat vuln.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "No critical vulnerabilities." >> $GITHUB_STEP_SUMMARY
          fi

      - name: CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
      - uses: github/codeql-action/analyze@v3

  # ==============================================================
  # 8. Outdated Packages (Warning Only)
  # ==============================================================
  outdated:
    name: Outdated Packages
    needs: restore
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install dotnet-outdated
        run: dotnet tool install --global dotnet-outdated-tool

      - name: Check outdated
        run: |
          echo "## Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          dotnet outdated ${{ env.SOLUTION }} \
            --format text \
            --upgrade \
            --include Major,Minor,Patch \
            || echo "No outdated packages or tool failed." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        shell: bash
