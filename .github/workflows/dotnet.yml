name: .NET 9 CI/CD
on:
  push:
    branches: [ main, dev, CI/CD ]
  pull_request:
    branches: [ main, dev, CI/CD ]

jobs:
  lint:
    name: Lint â€“ Full Roslyn Analyzers (only .cs)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore (to get analyzer packages)
        run: dotnet restore V2/V2.csproj

      - name: Find all .cs files (exclude .csproj, bin, obj)
        id: sources
        run: |
          SOURCES=$(find V2 -type f -name '*.cs' ! -name '*.csproj' ! -path '*/bin/*' ! -path '*/obj/*' | sort | tr '\n' ';')
          echo "sources=$SOURCES" >> $GITHUB_OUTPUT

      - name: Create temporary lint project
        run: |
          cat > /tmp/lint.csproj <<'EOF'
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <TargetFramework>net9.0</TargetFramework>
              <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
              <TreatWarningsAsErrors>false</TreatWarningsAsErrors>
              <RunAnalyzers>true</RunAnalyzers>
              <AnalysisLevel>latest</AnalysisLevel>
              <Nullable>enable</Nullable>
              <LangVersion>latest</LangVersion>
            </PropertyGroup>
            <ItemGroup>
          EOF

          # Add each .cs file as <Compile Include="..."/>
          for file in $(find V2 -type f -name '*.cs' ! -name '*.csproj' ! -path '*/bin/*' ! -path '*/obj/*' | sort); do
            echo "    <Compile Include=\"$file\" />" >> /tmp/lint.csproj
          done

          echo "  </ItemGroup>" >> /tmp/lint.csproj
          echo "</Project>" >> /tmp/lint.csproj

      - name: Run Analyzers on .cs files only
        run: |
          dotnet build /tmp/lint.csproj \
            --configuration Release \
            --no-restore \
            --verbosity minimal

  test:
    name: Test + Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Restore
        run: dotnet restore V2/V2.csproj
      - name: Run tests with coverage
        run: |
          dotnet test V2/V2.csproj \
            --collect:"XPlat Code Coverage" \
            --results-directory:./coverage \
            --verbosity normal
      - name: Generate HTML report
        uses: danielpalme/ReportGenerator-GitHub-Action@v5
        with:
          reports: 'coverage/**/coverage.cobertura.xml'
          targetdir: 'coverage/html'
          reporttypes: '
