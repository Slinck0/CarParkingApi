# .github/workflows/dotnet.yml
name: CI – V2 .NET 9 API

on:
  push:
    branches: [ main, CI/CD, dev, 'release/*' ]
    paths:
      - 'V2/**'
      - 'Parking-api.sln'
      - '.github/workflows/dotnet.yml'
  pull_request:
    branches: [ main, CI/CD, dev, 'release/*' ]
    paths:
      - 'V2/**'
      - 'Parking-api.sln'
      - '.github/workflows/dotnet.yml'

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

env:
  SOLUTION: Parking-api.sln
  PROJECT: V2/V2.csproj
  PUBLISH: V2/bin/Release/net9.0/linux-x64/publish
  ZIP: car-parking-api-v2-${{ github.sha }}.zip

jobs:
  # ==============================================================
  # 1. Restore + Cache
  # ==============================================================
  restore:
    name: Restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json', env.SOLUTION) }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - run: dotnet workload restore ${{ env.SOLUTION }} --verbosity minimal
      - run: dotnet restore ${{ env.SOLUTION }} --locked-mode

  # ==============================================================
  # 2. Lint & Format (Optional – does NOT block others)
  # ==============================================================
  lint:
    name: Lint & Format
    needs: restore
    runs-on: ubuntu-latest
    continue-on-error: true  # Never blocks other jobs
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Verify formatting
        run: |
          echo "Running formatting check..."
          dotnet format ${{ env.SOLUTION }} whitespace --verify-no-changes --verbosity quiet && \
          dotnet format ${{ env.SOLUTION }} style --verify-no-changes --verbosity quiet && \
          dotnet format ${{ env.SOLUTION }} analyzers --verify-no-changes --verbosity quiet || \
          (echo "Formatting issues found! Run 'dotnet format' locally to fix." && exit 1)
          echo "Formatting passed!"
        shell: bash

  # ==============================================================
  # 3. Unit Tests + 80% Coverage (Robust + Verbal)
  # ==============================================================
  unit-tests:
    name: Unit Tests + 80% Coverage
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Run unit tests with coverage
        run: |
          dotnet test ${{ env.SOLUTION }} \
            --no-restore --no-build -c Release \
            --collect:"XPlat Code Coverage" \
            --logger trx \
            --results-directory test-results \
            --filter "FullyQualifiedName!~Integration" \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=./coverage/

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/**

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/coverage.cobertura.xml

      - name: Enforce 80% coverage
        run: |
          echo "## Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FILE=$(find . -path "*/coverage/*.cobertura.xml" | head -n1)
          if [ -z "$FILE" ]; then
            echo "FAILED: No coverage file found!" >> $GITHUB_STEP_SUMMARY
            echo "Did tests run? Is Coverlet enabled?" >> $GITHUB_STEP_SUMMARY
            echo "Check the 'Run unit tests' step." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "Found coverage: $FILE" >> $GITHUB_STEP_SUMMARY

          RATES=$(grep -oP '<line-rate>\K[0-9.]+' "$FILE" | tr '\n' ' ')
          if [ -z "$RATES" ]; then
            echo "FAILED: Coverage file is empty!" >> $GITHUB_STEP_SUMMARY
            echo "No code was tested. Add unit tests!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          SUM=0; COUNT=0
          for r in $RATES; do
            SUM=$(echo "$SUM + $r" | bc -l)
            COUNT=$((COUNT + 1))
          done

          AVG=$(echo "scale=4; $SUM / $COUNT" | bc -l)
          PERCENT=$(echo "$AVG * 100" | bc -l | awk '{printf "%.2f", $1}')

          echo "Line coverage: **$PERCENT%** (from $COUNT report(s))" >> $GITHUB_STEP_SUMMARY

          if (( $(echo "$PERCENT < 80" | bc -l) )); then
            echo "FAILED: COVERAGE TOO LOW!" >> $GITHUB_STEP_SUMMARY
            echo "Current: $PERCENT% | Required: 80% or higher" >> $GITHUB_STEP_SUMMARY
            echo "Add more unit tests to reach 80%." >> $GITHUB_STEP_SUMMARY
            echo "Run locally: dotnet test /p:CollectCoverage=true" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "PASSED: Coverage $PERCENT% ≥ 80%" >> $GITHUB_STEP_SUMMARY
          fi

  # ==============================================================
  # 4. Integration Tests (Only on main or [run-integration])
  # ==============================================================
  integration-tests:
    name: Integration Tests
    needs: restore
    runs-on: ubuntu-latest
    if: >-
      github.ref == 'refs/heads/main' ||
      contains(github.event.pull_request.title, '[run-integration]')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - run: dotnet test ${{ env.SOLUTION }} \
          --no-restore --no-build -c Release \
          --filter "FullyQualifiedName~Integration" \
          --logger trx

  # ==============================================================
  # 5. Build
  # ==============================================================
  build:
    name: Build
    needs: restore
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - run: dotnet build ${{ env.SOLUTION }} \
          --no-restore -c Release \
          /p:TreatWarningsAsErrors=true \
          /p:RuntimeIdentifier=linux-x64

  # ==============================================================
  # 6. Publish + Zip
  # ==============================================================
  publish:
    name: Publish Artifact
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish
        run: |
          dotnet publish ${{ env.PROJECT }} \
            -c Release --no-build --self-contained false \
            --runtime linux-x64 --output ${{ env.PUBLISH }}

      - name: Create zip
        run: |
          cd V2/bin/Release/net9.0/linux-x64
          zip -r "${{ github.workspace }}/${{ env.ZIP }}" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP }}
          path: ${{ env.ZIP }}
          retention-days: 7

  # ==============================================================
  # 7. Security Scan (CodeQL + Vulns)
  # ==============================================================
  security:
    name: Security Scan
    needs: [restore, build]   # Must wait for build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Check vulnerable packages
        run: |
          echo "## Vulnerable Packages" >> $GITHUB_STEP_SUMMARY
          dotnet list ${{ env.PROJECT }} package --vulnerable --include-transitive > vuln.txt || true
          if grep -q "has the following vulnerable packages" vuln.txt; then
            echo "CRITICAL VULNERABILITIES FOUND!" >> $GITHUB_STEP_SUMMARY
            cat vuln.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "No critical vulnerabilities." >> $GITHUB_STEP_SUMMARY
          fi

      - name: CodeQL Init
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          config-file: .github/codeql.yml

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ==============================================================
  # 8. Outdated Packages (Warning Only)
  # ==============================================================
  outdated:
    name: Outdated Packages
    needs: restore
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install dotnet-outdated
        run: dotnet tool install --global dotnet-outdated-tool

      - name: Check outdated
        run: |
          echo "## Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          dotnet outdated ${{ env.SOLUTION }} \
            --format text \
            --upgrade \
            --include Major,Minor,Patch \
            || echo "No outdated packages or tool failed." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        shell: bash
